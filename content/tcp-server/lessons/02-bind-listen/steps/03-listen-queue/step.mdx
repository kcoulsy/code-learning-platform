---
id: 03-listen-queue
title: 'The Listen Queue'
order: 3
---

# The Listen Queue

When a server calls `listen()`, it creates a queue for pending connections. Understanding this queue is crucial for building responsive servers.

## How the Queue Works

```
Client                    Server
   |                        |
   |--- SYN --------------->|  (connection request)
   |                        |
   |<-- SYN-ACK ------------|  (server acknowledges)
   |                        |
   |--- ACK --------------->|  (client acknowledges)
   |                        |
   |         [Incomplete connection in queue]
   |                        |
   |     accept() removes from queue
   |                        |
   |<====== TCP Connection Established ======>
```

## The Backlog Parameter

The backlog specifies the maximum number of **incomplete** connections in the queue. When the queue is full:

- New SYN packets are ignored
- The client may experience connection timeouts
- No RST is sent (stealthy queue full)

```c
// Different backlog values
listen(server_fd, 5);   // Classic default
listen(server_fd, 128); // Modern default for high-traffic servers
```

## Complete Listen Example

```c
#include <stdio.h>
#include <sys/socket.h>
#include <netinet/in.h>

#define PORT 8080
#define BACKLOG 10

int main() {
    int server_fd = socket(AF_INET, SOCK_STREAM, 0);

    struct sockaddr_in address;
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    // Bind
    bind(server_fd, (struct sockaddr*)&address, sizeof(address));

    // Listen with backlog
    if (listen(server_fd, BACKLOG) == -1) {
        perror("listen");
        return 1;
    }

    printf("Server listening with backlog=%d\n", BACKLOG);
    printf("Run: netstat -tlnp | grep %d\n", PORT);

    // Keep server running
    while (1) sleep(1);

    return 0;
}
```

## Monitoring the Queue

```bash
# Run the server in background
./server &
# Server listening with backlog=10

# Check listening sockets
netstat -tlnp | grep 8080
# tcp  LISTEN  0  10  0.0.0.0:8080  0.0.0.0:*  users:(("server",pid=12345,fd=3))

# The "10" after LISTEN shows the current queue depth
```

## The Completed Connection Queue

Linux actually maintains two queues:

1. **SYN queue** (incomplete connections)
2. **Accept queue** (completed connections waiting for `accept()`)

The `backlog` parameter affects both on modern Linux.

## Choosing a Backlog Value

| Situation               | Recommended Backlog              |
| ----------------------- | -------------------------------- |
| Low traffic server      | 5-10                             |
| High traffic server     | 100-2048                         |
| Thundering herd concern | Lower value + multiple processes |

Start with 10-128 and adjust based on your application's needs.
